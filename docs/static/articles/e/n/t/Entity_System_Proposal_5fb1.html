<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<!-- headlinks removed -->
	<link rel="shortcut icon" href="../../../../misc/favicon.ico"/>
    <title>Entity System Proposal - Peragro Tempus Wiki</title>
    <style type="text/css">/*<![CDATA[*/ @import "../../../../skins/offline/main.css"; /*]]>*/</style>
    <link rel="stylesheet" type="text/css" media="print" href="../../../../skins/common/commonPrint.css" />
    <!--[if lt IE 5.5000]><style type="text/css">@import "../../../../skins/monobook/IE50Fixes.css";</style><![endif]-->
    <!--[if IE 5.5000]><style type="text/css">@import "../../../../skins/monobook/IE55Fixes.css";</style><![endif]-->
    <!--[if IE 6]><style type="text/css">@import "../../../../skins/monobook/IE60Fixes.css";</style><![endif]-->
    <!--[if IE]><script type="text/javascript" src="../../../../skins/common/IEFixes.js"></script>
    <meta http-equiv="imagetoolbar" content="no" /><![endif]-->
    <script type="text/javascript" src="../../../../skins/common/wikibits.js"></script>
    <script type="text/javascript" src="../../../../skins/offline/md5.js"></script>
    <script type="text/javascript" src="../../../../skins/offline/utf8.js"></script>
    <script type="text/javascript" src="../../../../skins/offline/lookup.js"></script>
    <script type="text/javascript" src="../../../../raw/gen.js"></script>        <style type="text/css">/*<![CDATA[*/
@import "../../../../raw/MediaWiki%7ECommon.css";
@import "../../../../raw/MediaWiki%7EMonobook.css";
@import "../../../../raw/gen.css";
/*]]>*/</style>          </head>
  <body
    class="page-Entity_System_Proposal">
    <div id="globalWrapper">
      <div id="column-content">
	<div id="content">
	  <a name="top" id="contentTop"></a>
	        <h1 class="firstHeading">Entity System Proposal</h1>
	  <div id="bodyContent">
	    <h3 id="siteSub">From Peragro Tempus Wiki</h3>
	    <div id="contentSub"></div>
	    	    	    <!-- start content -->
	    <table id="toc" class="toc" summary="Contents"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1"><a href="#Motivation"><span class="tocnumber">1</span> <span class="toctext">Motivation</span></a></li>
<li class="toclevel-1"><a href="#Requirements"><span class="tocnumber">2</span> <span class="toctext">Requirements</span></a></li>
<li class="toclevel-1"><a href="#Overview"><span class="tocnumber">3</span> <span class="toctext">Overview</span></a></li>
<li class="toclevel-1"><a href="#Components"><span class="tocnumber">4</span> <span class="toctext">Components</span></a></li>
<li class="toclevel-1"><a href="#Behaviors"><span class="tocnumber">5</span> <span class="toctext">Behaviors</span></a></li>
<li class="toclevel-1"><a href="#Entity_Templates"><span class="tocnumber">6</span> <span class="toctext">Entity Templates</span></a>
<ul>
<li class="toclevel-2"><a href="#Entities"><span class="tocnumber">6.1</span> <span class="toctext">Entities</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Entity_Instances"><span class="tocnumber">7</span> <span class="toctext">Entity Instances</span></a></li>
<li class="toclevel-1"><a href="#Networking_and_Client.2FServer_Interaction"><span class="tocnumber">8</span> <span class="toctext">Networking and Client/Server Interaction</span></a>
<ul>
<li class="toclevel-2"><a href="#Synchronization_of_Properties"><span class="tocnumber">8.1</span> <span class="toctext">Synchronization of Properties</span></a></li>
<li class="toclevel-2"><a href="#Actions"><span class="tocnumber">8.2</span> <span class="toctext">Actions</span></a></li>
<li class="toclevel-2"><a href="#Storage"><span class="tocnumber">8.3</span> <span class="toctext">Storage</span></a></li>
<li class="toclevel-2"><a href="#Editing"><span class="tocnumber">8.4</span> <span class="toctext">Editing</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Server"><span class="tocnumber">9</span> <span class="toctext">Server</span></a>
<ul>
<li class="toclevel-2"><a href="#Initialization"><span class="tocnumber">9.1</span> <span class="toctext">Initialization</span></a></li>
<li class="toclevel-2"><a href="#On_Connect"><span class="tocnumber">9.2</span> <span class="toctext">On Connect</span></a></li>
<li class="toclevel-2"><a href="#Walking_Around"><span class="tocnumber">9.3</span> <span class="toctext">Walking Around</span></a></li>
<li class="toclevel-2"><a href="#Shutdown"><span class="tocnumber">9.4</span> <span class="toctext">Shutdown</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Client"><span class="tocnumber">10</span> <span class="toctext">Client</span></a>
<ul>
<li class="toclevel-2"><a href="#Initialization_2"><span class="tocnumber">10.1</span> <span class="toctext">Initialization</span></a></li>
<li class="toclevel-2"><a href="#On_Connect_2"><span class="tocnumber">10.2</span> <span class="toctext">On Connect</span></a></li>
<li class="toclevel-2"><a href="#Walking_Around_2"><span class="tocnumber">10.3</span> <span class="toctext">Walking Around</span></a></li>
<li class="toclevel-2"><a href="#Disconnecting"><span class="tocnumber">10.4</span> <span class="toctext">Disconnecting</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Example"><span class="tocnumber">11</span> <span class="toctext">Example</span></a></li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "show"; var tocHideText = "hide"; showTocToggle(); } </script>
<a name="Motivation"></a><h1> <span class="mw-headline"> Motivation </span></h1>
<p>The entity system represents the framework for all of the gameplay code in a game. Since development of gameplay occurs iteratively and requirements change, the entity system should be designed such that changes can be made and tested easily. In a MMORPG, there are many different types and instances of entities in the game world. In addition to the issue of scale, entities must be serialized across the network and persisted to the server's database. In synchronizing entities, server authority must not be compromised. World Designers should be able to define a hierarchy of reusable entity templates, and create and modify instances of entities in the game world over the network in real-time.
</p>
<a name="Requirements"></a><h1> <span class="mw-headline"> Requirements </span></h1>
<ul><li> Editing in real-time over network
</li><li> Automatic serialization to network and database
</li><li> Lightweight multi-threaded behaviors
</li><li> Scripting language for gameplay code
</li><li> Client/server separation
</li><li> Server authority
</li><li> Streaming of entities to client
</li></ul>
<a name="Overview"></a><h1> <span class="mw-headline"> Overview </span></h1>
<p><a href="../../../../articles/e/n/t/Image%7EEntity_system.png_7a92.html" class="image" title="Image:Entity_system.png"><img alt="Image:Entity_system.png" src="../../../../../images/2/24/Entity_system.png" width="982" height="542" border="0" /></a>
</p>
<a name="Components"></a><h1> <span class="mw-headline"> Components </span></h1>
<p>Components are all defined in C++ and are the basic bulding blocks for entities, such as "mesh", "cdobject", or "item".
Each component has a number of functions and properties. For example, the "mesh" component would have a property for which mesh file to use.
Components can depend on each other. For example, both "mesh" and "cdobject" can depend on a common "physicalposition" component, which they both use.
</p>
<a name="Behaviors"></a><h1> <span class="mw-headline"> Behaviors </span></h1>
<p>Behaviors are event handlers written in Python. Behaviors consist of a set of methods that handle the events that they wish to subscribe to.
</p>
<a name="Entity_Templates"></a><h1> <span class="mw-headline"> Entity Templates </span></h1>
<p>By grouping a number of components, setting properties, defining properties, and attaching behaviors, you create an entity template.
Examples of templates are: "monster", and "weapon".
Templates can inherit from other templates. So you can have a "skeletonmonster" that inherits from "monster" and defines or sets some additional properties or behaviors specific to the skeleton monster.
</p>
<a name="Entities"></a><h2> <span class="mw-headline"> Entities </span></h2>
<p>Entities are "complete" templates. That is, entities have all properties and behaviors defined. They are ready for instantiation.
</p>
<a name="Entity_Instances"></a><h1> <span class="mw-headline"> Entity Instances </span></h1>
<p>These are instantiations of entities. Entity instances can only set properties, they cannot define new properties or behaviors. They are the actual things loaded into memory that you might see in the game world.
</p>
<a name="Networking_and_Client.2FServer_Interaction"></a><h1> <span class="mw-headline"> Networking and Client/Server Interaction </span></h1>
<a name="Synchronization_of_Properties"></a><h2> <span class="mw-headline"> Synchronization of Properties </span></h2>
<p>Properties have flags that indicate the how often they are synchronized and at what priority, whether they are server-authoritative or client-authoritative, and if they are private (not to be transmitted to other players).
</p><p>To elaborate on the client/server-authoritative flag, it is mainly a security thing. The server won't apply property updates from a client to a server-authoritative property.
Things like walking where the client is performing an action have to be handled through action system, not through property synchronization.
</p><p>Two sets of entities exist on both the client and server: global entities and local entities.
Global entities transmit updates regardless of player position.
Local entities are synchronized within a certain radius of the player.
The server will tell the client when an entity enters and exits the local area. When an entity exists the local area, the client doesn't have to delete it then, since other entities may be referring to it. A reference is simply a property which refers to the ID of an instance of the specified type.
</p><p>A lot of properties the server simply doesn't care about, so these would be marked as client-only, or server-only for the opposite case.
</p>
<a name="Actions"></a><h2> <span class="mw-headline"> Actions </span></h2>
<p>Actions are requested by sending a request from one side (client or server) to the other with optional parameters. The other side validates the request and if it passes, carries out the action.
</p><p>Actions are handled by the behavior. The behavior receives two events: "validate" and "perform" in which it  validates the request and performs the action, respectively.
</p><p>Actions should be primarily used for actions sent by the client which require server validation, like walking (requires collision detection) or equipping an inventory item.
</p><p>In response to an action, the server usually wants to send updates to the nearby players.
</p>
<a name="Storage"></a><h2> <span class="mw-headline"> Storage </span></h2>
<p>Templates, entity definitions, and behaviors are stored in files. They are parsed when the server starts.
Entity instances are stored in separate tables, with one table for each entity type. These tables are created if they don't exist when the server loads.
Properties that need to be serialized are marked with a savable flag.
</p><p>The server will periodically save entity instances in memory to the database, or when told to do so due to some major change.
</p>
<a name="Editing"></a><h2> <span class="mw-headline"> Editing </span></h2>
<p>Entity instances can be changed in real-time over the network by the editor.
</p><p>Changes to templates, entity definitions, behaviors, or components must be committed to the SVN repository. The server must then be told to perform an "svn update" (and compile any new C++ code if present).
</p><p>The server will then take the following steps on the next reload:
</p>
<ul><li> Create any new tables for new entities and fill them with default values
</li><li> Execute any data migration functions that may be present
</li></ul>
<a name="Server"></a><h1> <span class="mw-headline"> Server </span></h1>
<a name="Initialization"></a><h2> <span class="mw-headline"> Initialization </span></h2>
<ul><li> Read entity templates
</li><li> Create table for each "complete" entity template if table does not already exist
</li><li> If the table does exist, run data migration functions, if present
</li><li> Load game world
</li></ul>
<a name="On_Connect"></a><h2> <span class="mw-headline"> On Connect </span></h2>
<ul><li> Check client version - if old, give URL of update server
</li><li> Send client all "complete" entity definitions and client-side behaviors
</li></ul>
<a name="Walking_Around"></a><h2> <span class="mw-headline"> Walking Around </span></h2>
<ul><li> Periodically send any local changes within certain radius of player and global changes
</li><li> Stream new entity when entity is within radius of player
</li></ul>
<a name="Shutdown"></a><h2> <span class="mw-headline"> Shutdown </span></h2>
<a name="Client"></a><h1> <span class="mw-headline"> Client </span></h1>
<a name="Initialization_2"></a><h2> <span class="mw-headline"> Initialization </span></h2>
<ul><li> Load meshes, textures, and sounds.
</li><li> Wait for user to connect
</li></ul>
<a name="On_Connect_2"></a><h2> <span class="mw-headline"> On Connect </span></h2>
<ul><li> Tell server what version of the content we have - download updates if necessary
</li><li> Read "complete" entity definitions and behaviors sent by the server and keep in memory
</li></ul>
<a name="Walking_Around_2"></a><h2> <span class="mw-headline"> Walking Around </span></h2>
<ul><li> Receive and apply any updates from server
</li><li> Instantiate entities that the server tells us have come into the local area
</li><li> Delete any entities the server says have left the local area as long as there are no references to those entities
<ul><li> If there are references, wait until references no longer exist, then remove entity
</li></ul>
</li><li> Send walk action requests to server
<ul><li> Do we want to do client-side movement even if it gets out of sync?
</li></ul>
</li></ul>
<a name="Disconnecting"></a><h2> <span class="mw-headline"> Disconnecting </span></h2>
<ul><li> Tell server we are disconnecting
</li><li> Go back to main menu
</li></ul>
<a name="Example"></a><h1> <span class="mw-headline"> Example </span></h1>
<pre>
class Door(Entity):
  # Components
  transform = TransformComponent()
  mesh = MeshComponent()
  
  # Properties
  state = EnumProperty([&quot;Open&quot;, &quot;Opening&quot;, &quot;Closing&quot;, &quot;Closed&quot;], default=2)
  
  # Constants
  duration = 1000
  minDistance = 2
  
  # Actions
  openAction = Action()
  closeAction = Action()


# Client side
class ClientDoor(Door):
  # Components
  interactable = InteractableComponent()
  
  # Event handlers
  interactable.onInteract = onInteract
  state.onUpdate = onStateUpdate
  
  def onStateUpdate(self):
    if self.state == &quot;Opening&quot;:
      self.transform.rotateZ(-pi/2, self.duration)
    elif self.state == &quot;Closing&quot;:
      self.transform.rotateZ(pi/2, self.duration)
  
  def onInteract(self, player):
    if self.state == &quot;Closed&quot;:
      self.openAction()
    else:
      self.closeAction()


# Server side
class ServerDoor(Door):
  # Event handlers
  openAction.OnPerform = onOpenAction
  closeAction.OnPerform = onCloseAction
  
  def onOpenAction(self, player):
    if player.distanceTo(self.transform) &lt;= self.minDistance:
      if self.state == &quot;Closing&quot; or self.state == &quot;Closed&quot;:
        self.state = &quot;Opening&quot;
        self.localEntities.sendUpdate(self.state)
        sleep(self.duration)
        self.state = &quot;Open&quot;
        self.localEntities.sendUpdate(self.state)
  
  def onCloseAction(self, player):
    if player.distanceTo(self.transform) &lt;= self.minDistance:
      if self.state == &quot;Opening&quot; or self.state == &quot;Open&quot;:
        self.state = &quot;Closing&quot;
        self.localEntities.sendUpdate(self.state)
        sleep(self.duration)
        self.state = &quot;Closed&quot;
        self.localEntities.sendUpdate(self.state)
</pre>

<!-- 
NewPP limit report
Preprocessor node count: 28/1000000
Post-expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Expensive parser function count: 0/100
-->
<div class="printfooter">
</div>
	    <div id="catlinks"><div id='catlinks' class='catlinks'><div id="mw-normal-catlinks"><a href="../../../../articles/c/a/t/Special%7ECategories_101d.html" title="Special:Categories">Category</a>:&#32;<span dir='ltr'><a href="../../../../articles/p/r/o/Category%7EProposals_d172.html" title="Category:Proposals">Proposals</a></span></div></div></div>	    <!-- end content -->
	    <div class="visualClear"></div>
	  </div>
	</div>
      </div>
      <div id="column-one">
	<div id="p-cactions" class="portlet">
	  <h5>Views</h5>
	  <ul>
	    <li id="ca-nstab-main"
	       class="selected"	       ><a href="../../../../articles/e/n/t/Entity_System_Proposal_5fb1.html">Page</a></li><li id="ca-talk"
	       class="new"	       ><a href="../../../../articles/e/n/t/Talk%7EEntity_System_Proposal_b4b5.html">Discussion</a></li><li id="ca-current"
	       	       ><a href="http://localhost/index.php/Entity_System_Proposal">Current revision</a></li>	  </ul>
	</div>
	<div class="portlet" id="p-logo">
	  <a style="background-image: url(../../../../misc/clock_half.png);"
	    href="../../../../index.html"
	    title="Main Page"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		<div class='portlet' id='p-navigation'>
	  <h5>Navigation</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-mainpage-description"><a href="../../../../index.html">Main Page</a></li>
	     	      <li id="n-portal"><a href="../../../../articles/c/o/m/Peragro_Tempus_Wiki%7ECommunity_Portal_9ca7.html">Community portal</a></li>
	     	      <li id="n-currentevents"><a href="../../../../articles/c/u/r/Peragro_Tempus_Wiki%7ECurrent_events_57bd.html">Current events</a></li>
	     	      <li id="n-recentchanges"><a href="../../../../articles/r/e/c/Special%7ERecentChanges_e0d0.html">Recent changes</a></li>
	     	      <li id="n-help"><a href="../../../../articles/c/o/n/Help%7EContents_22de.html">Help</a></li>
	     	    </ul>
	  </div>
	</div>
		<div class='portlet' id='p-SEARCH'>
	  <h5>SEARCH</h5>
	  <div class='pBody'>
	    <ul>
	    	    </ul>
	  </div>
	</div>
		<div class='portlet' id='p-TOOLBOX'>
	  <h5>TOOLBOX</h5>
	  <div class='pBody'>
	    <ul>
	    	    </ul>
	  </div>
	</div>
		<div class='portlet' id='p-LANGUAGES'>
	  <h5>LANGUAGES</h5>
	  <div class='pBody'>
	    <ul>
	    	    </ul>
	  </div>
	</div>
		<div id="p-search" class="portlet">
	  <h5><label for="searchInput">Search</label></h5>
	  <div id="searchBody" class="pBody">
	    <form action="javascript:goToStatic(3)" id="searchform"><div>
	      <input id="searchInput" name="search" type="text"
	        accesskey="f" value="" />
	      <input type='submit' name="go" class="searchButton" id="searchGoButton"
	        value="Go" />
	    </div></form>
	  </div>
	</div>
	      </div><!-- end of the left (by default at least) column -->
      <div class="visualClear"></div>
      <div id="footer">
    <div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="../../../../skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>		<ul id="f-list">
	  	  	  <li id="f-credits">This page was last modified 06:40, 26 January 2007 by <a href="../../../../articles/i/c/e/User%7EIceeey_a6d0.html" title="User:Iceeey">Seth</a>. Based on work by <a href="../../../../articles/s/u/e/User%7ESueastside_0e95.html" title="User:Sueastside">Jelle Hellemans</a>.</li>	  	  <li id="f-about"><a href="../../../../articles/a/b/o/Peragro_Tempus_Wiki%7EAbout_5c7d.html" title="Peragro Tempus Wiki:About">About Peragro Tempus Wiki</a></li>	  <li id="f-disclaimer"><a href="../../../../articles/g/e/n/Peragro_Tempus_Wiki%7EGeneral_disclaimer_934d.html" title="Peragro Tempus Wiki:General disclaimer">Disclaimers</a></li>	  	</ul>
      </div>
    </div>
  </body>
</html>
