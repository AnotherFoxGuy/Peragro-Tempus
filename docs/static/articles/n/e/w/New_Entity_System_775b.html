<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<!-- headlinks removed -->
	<link rel="shortcut icon" href="../../../../misc/favicon.ico"/>
    <title>New Entity System - Peragro Tempus Wiki</title>
    <style type="text/css">/*<![CDATA[*/ @import "../../../../skins/offline/main.css"; /*]]>*/</style>
    <link rel="stylesheet" type="text/css" media="print" href="../../../../skins/common/commonPrint.css" />
    <!--[if lt IE 5.5000]><style type="text/css">@import "../../../../skins/monobook/IE50Fixes.css";</style><![endif]-->
    <!--[if IE 5.5000]><style type="text/css">@import "../../../../skins/monobook/IE55Fixes.css";</style><![endif]-->
    <!--[if IE 6]><style type="text/css">@import "../../../../skins/monobook/IE60Fixes.css";</style><![endif]-->
    <!--[if IE]><script type="text/javascript" src="../../../../skins/common/IEFixes.js"></script>
    <meta http-equiv="imagetoolbar" content="no" /><![endif]-->
    <script type="text/javascript" src="../../../../skins/common/wikibits.js"></script>
    <script type="text/javascript" src="../../../../skins/offline/md5.js"></script>
    <script type="text/javascript" src="../../../../skins/offline/utf8.js"></script>
    <script type="text/javascript" src="../../../../skins/offline/lookup.js"></script>
    <script type="text/javascript" src="../../../../raw/gen.js"></script>        <style type="text/css">/*<![CDATA[*/
@import "../../../../raw/MediaWiki%7ECommon.css";
@import "../../../../raw/MediaWiki%7EMonobook.css";
@import "../../../../raw/gen.css";
/*]]>*/</style>          </head>
  <body
    class="page-New_Entity_System">
    <div id="globalWrapper">
      <div id="column-content">
	<div id="content">
	  <a name="top" id="contentTop"></a>
	        <h1 class="firstHeading">New Entity System</h1>
	  <div id="bodyContent">
	    <h3 id="siteSub">From Peragro Tempus Wiki</h3>
	    <div id="contentSub"></div>
	    	    	    <!-- start content -->
	    <table id="toc" class="toc" summary="Contents"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1"><a href="#Entities.2C_components.2C_properties.2C_and_behaviours"><span class="tocnumber">1</span> <span class="toctext">Entities, components, properties, and behaviours</span></a>
<ul>
<li class="toclevel-2"><a href="#Components"><span class="tocnumber">1.1</span> <span class="toctext">Components</span></a>
<ul>
<li class="toclevel-3"><a href="#Base_Component_Class"><span class="tocnumber">1.1.1</span> <span class="toctext">Base Component Class</span></a></li>
</ul>
</li>
<li class="toclevel-2"><a href="#Properties"><span class="tocnumber">1.2</span> <span class="toctext">Properties</span></a></li>
<li class="toclevel-2"><a href="#Behaviours"><span class="tocnumber">1.3</span> <span class="toctext">Behaviours</span></a></li>
<li class="toclevel-2"><a href="#Entities"><span class="tocnumber">1.4</span> <span class="toctext">Entities</span></a></li>
<li class="toclevel-2"><a href="#Property_syncing_and_filtering"><span class="tocnumber">1.5</span> <span class="toctext">Property syncing and filtering</span></a></li>
</ul>
</li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "show"; var tocHideText = "hide"; showTocToggle(); } </script>
<a name="Entities.2C_components.2C_properties.2C_and_behaviours"></a><h1> <span class="mw-headline">Entities, components, properties, and behaviours</span></h1>
<p>Entities, components, properties, and behaviours are the main backbone of the new entity proposal. The idea behind this system is to allow maximum customisability when adding new content to the game or creating a new game, with as little changes to C++ code as possible. This should serve several purposes:
</p>
<ol><li> easier creation of new game content
</li><li> less time spent in (re)compiling the server/client
</li><li> greater variation in game content even without changes to the main engine
</li></ol>
<p>Only the most CPU-intensive parts of the engine are implemented in C++ (hard-coded), while the majority of actual rules and objects are implemented using a scripting language. The scripting language will probably be Python.
</p>
<a name="Components"></a><h2> <span class="mw-headline">Components</span></h2>
<p>Components are basic building blocks in creation of any entity. Each component implements a very narrow area of engine. The reasoning behind this is to allow the designer of a game to achieve functionality by combining various components into actual entities, instead of using one big hard-coded class/object. This allows for much better flexibility of code, and alleviates huge changes in code that are usually required when adding new types of objects into the game.
</p><p>Let's say that the following three components exist: one that implements functionality needed for talking, one that implements functionality needed for wearable items, and one that implements a property bag (that is, a component which can be filled with various parameters). With all the three components one could create a talking sword. With the ones that implement functionality for wearable items and property bags, one could implement various kinds of plain weapons, armours, and other types of wearable items. The one that provides functionality for talking would also be used for NPCs.
</p><p>One more good example would be a component that provides functionality for collision detection to entities. Not all entities would need to have such a feature (for example a passage in wall that should be masked with an illusion of a wall - such entity could have a mesh component, but no collision-detection should be performed on it, therefor it shouldn't use collision-detection component).
</p><p>Each component is derived from a single abstract base class which provides common interface for handling all the instances of child classes. The interface provided is used for obtaining copies of component and similar generic tasks that are independent of the actual functionality provided by the components.
</p><p>Each component can depend on one or more of the other components. This allows for a finely structured dependency tree, and avoids the unnecessary code duplication. Dependency is not achieved via class inheritance, though. In order to achieve such functionality, each component must be able to access the components of its parent, or at the very least the components of parent it depends on.
</p><p>As an example, a collision detection component might depend on position component, and mesh component. On the other hand, some other components might depend on position/mesh components of an entity, like rendering component.
</p><p>Each component may contain some properties that vary in nature and type. These properties serve the purpose of implementing needed functionality in a component by providing data specific for the given component. Each component exposes an interface for setting and retrieving of a select number of its properties to the scripts.
</p>
<a name="Base_Component_Class"></a><h3> <span class="mw-headline">Base Component Class</span></h3>
<code><pre>
class Component{
    private:
    protected:
    public:
    };
</pre></code>
<a name="Properties"></a><h2> <span class="mw-headline">Properties</span></h2>
<p>Properties belong to components. Properties hold component-specific data for an entity they belong to.
</p><p>For example, in case of a mesh component, there may be a property that either holds the actual mesh, or in some way references the location of a mesh.
</p><p>Properties need to accommodate various types of data. Since this includes non-elementary types as well (i.e. not only integers, floats, doubles, but std::string's, custom classes, etc as well), usage of unions is out of the question. A more powerful mechanism needs to be used in its place, but with similar capabilities. Boost library provides a class called 'variant' that fits well into this role. It provides a union-like functionality for advanced data types (like arbitrary classes). Amongst other things, properties need to allow for lists (std::list), vectors (std::vector), and maps (std::map), or any other similar complex structures.
</p><p>Although most properties may be set by individual commands, an interface for setting multiple properties in the same run should be provided where appropriate (see the explanation of Behaviours below).
</p><p>Properties need to be kept in sync on server and clients. Whenever a property changes server-side, the server sends property update messages to appropriate clients (see the Property syncing and filtering section as well). Likewise, when a certain property gets changed client-side, its new value is transmitted to the server if client is allowed to change the particular property (server _must_ make sure the property update it's being sent from some client is allowed for that client or not). Some properties, though, are client-only, and as such should not be sent to server.
</p><p>Each property has a permissions flag attached to it. This flag determines who can perform the direct property change on a server. This flag can be set to "server", "client", or "client-only". If set to "server", it means that only the server can change the value of property directly. If set to "client", only a single client may change the property directly, in addition to server. If set to "client-only", it means that the property is not being synced to server, that is - it's a property which is internal for each client. This security system is in place in order to make sure that properties are changed via syncing by only the allowed clients or only by server, as well as to avoid sending of unnecessary data to the server by client (like camera positions, for example). Clients may cause a change of properties indirectly, though, for example if some behaviour gets triggered.
</p><p>As an example, a client is allowed to change the description of a player character belonging to that client, while on the other hand it shouldn't be able to change leftover stamina. Leftover stamina _may_ be changed indirectly, though, by player attacking some monster (this is triggered by a script, actually).
</p>
<a name="Behaviours"></a><h2> <span class="mw-headline">Behaviours</span></h2>
<p>Behaviours implement the game mechanics/rules (i.e. fighting, crafting, etc). Behaviours are called when certain criteria are met. Behaviours are implemented using a scripting language, which allows for easier change of game mechanics and better flexibility. Behaviours, or behaviour scripts, access the component properties and methods via interface exposed by components themselves.
</p><p>Behaviours are triggered by property changes. Each component must contain a list of which behaviour gets called for which property change. Not all property changes need to yield an execution of a behaviour. Whenever a property value gets changed, behaviour scripts are triggered for that change, if any are defined for it. Behaviours can also be associated with multiple-property changes (i.e. when several properties get changed at the same time, for example in case of a map change, where map and coordinates get changed).
</p>
<a name="Entities"></a><h2> <span class="mw-headline">Entities</span></h2>
<p>An entity is comprised out of components and behaviours. Entities are the actual objects being added to the world. Components and behaviours cannot exist outside of entities.
</p><p>Each entity has a flag which defines if the entity should be instantiated in the world or not. This allows for creation of abstract "templates" which are used for creation of actual entities in the world.
</p><p>For example, a door entity might be comprised out of a collision detection component, and a "property bag" component (which contains the current status of the door, its strength, information about locks etc), as well as script that would handle changes on the door (door being broken down, or being opened/closed).
</p><p>An entity can be defined in two ways. First way would be to define it from grounds up, specifying which components the entity is composed of, default values specified for certain properties, which behaviours get called upon which property changes, and other similar information. The second way to define a new entity would be to inherit the characteristics of another entity, and then either add some new functionality to it by adding new components or behaviours to it, or altering those inherited characteristics.
</p><p>For example, it might be possible to define an entity which would represent a skeleton from grounds up. This entity wouldn't be instantiable, although it would contain everything that is needed for such a monster to function (i.e. it would have position component, behaviour scripts which would let it attack others etc). In order to add an actual skeleton entity to the world, one would inherit this template, change the default values for the position of entity, maybe alter some other aspects of the entity (like its strength), and possibly add some more behaviour scripts that would be specific to the area where the monster would be "spawned". This way a whole plethora of skeleton entities could be created, each with a little different parameters, yet with the same base.
</p><p>Entity definitions would be read from a file (probably XML), which would list all the details needed for functioning of entities.
</p><p>Client and server _may_, and probably _will_ have different entity definitions, although those will be similar in some parts.
</p>
<a name="Property_syncing_and_filtering"></a><h2> <span class="mw-headline">Property syncing and filtering</span></h2>
<p>In each server-multiclient environment it is essential to control which data is being transmitted between the server and each particular client. This is both in order to reduce bandwidth usage, and to prevent cheating by players. In other words, a mechanism for filtering of property syncing must be put in place. There can be many ways to implement this, but they all have trade-offs. A system of "entity states" will be discussed below.
</p><p>Each client connected to server has a separate list (server-side) which defines which entities the client should be aware of. Of course, the client should not be aware of all the properties each listed entity has. This is achieved by assigning some predefined state to each entity. States are defined in the entity definition files. Each state lists the properties that the client should be aware of when that particular state is in effect. When an entity enters a particular state, property updates are being transmitted to the client only for those properties which are listed for that state.
</p><p>For example, let's say the player walks near an NPC trader. The particular NPC trader has two states - "idle", and "trading". When in idle state, only the NPCs position and "public" talk (something what every player should hear, like "Come, come, I have some new items of interest for you.") is being transmitted to the client. When in trading state, the client is also being sent the list of items, and their costs. Server detects that the player is near the NPC trader, so it sends to client information about new entity, along with the information that the NPC trader entity is now in the "idle" state. The client doesn't bother with keeping track of items the NPC trader has, since this information is not transmitted to it. It does update trader's position if it changes, though. After a while the player initiates a trade. Server is being informed about this, changes the state to "trading", and sends information about the state change to the client along the list of items and their prices. Client detects this, shows the trade window, and starts keeping track of any changes of the available items and prices. Server also makes sure the item/prices updates are being sent over to the client. Player finally decides he doesn't have enough money, and aborts the trade. Server gets notified, changes the NPC trader's state to "idle", and informs the client about the change of state. Server also stops transmitting the updates of items/prices to client. Client might still keep track of the items/prices it originally was receiving, but this data is not up-to-date anymore since server is not sending him the updates anymore.
</p>
<!-- 
NewPP limit report
Preprocessor node count: 12/1000000
Post-expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Expensive parser function count: 0/100
-->
<div class="printfooter">
</div>
	    <div id="catlinks"><div id='catlinks' class='catlinks'><div id="mw-normal-catlinks"><a href="../../../../articles/c/a/t/Special%7ECategories_101d.html" title="Special:Categories">Category</a>:&#32;<span dir='ltr'><a href="../../../../articles/c/o/d/Category%7ECode_d87b.html" title="Category:Code">Code</a></span></div></div></div>	    <!-- end content -->
	    <div class="visualClear"></div>
	  </div>
	</div>
      </div>
      <div id="column-one">
	<div id="p-cactions" class="portlet">
	  <h5>Views</h5>
	  <ul>
	    <li id="ca-nstab-main"
	       class="selected"	       ><a href="../../../../articles/n/e/w/New_Entity_System_775b.html">Page</a></li><li id="ca-talk"
	       class="new"	       ><a href="../../../../articles/n/e/w/Talk%7ENew_Entity_System_0ae1.html">Discussion</a></li><li id="ca-current"
	       	       ><a href="http://localhost/index.php/New_Entity_System">Current revision</a></li>	  </ul>
	</div>
	<div class="portlet" id="p-logo">
	  <a style="background-image: url(../../../../misc/clock_half.png);"
	    href="../../../../index.html"
	    title="Main Page"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		<div class='portlet' id='p-navigation'>
	  <h5>Navigation</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-mainpage-description"><a href="../../../../index.html">Main Page</a></li>
	     	      <li id="n-portal"><a href="../../../../articles/c/o/m/Peragro_Tempus_Wiki%7ECommunity_Portal_9ca7.html">Community portal</a></li>
	     	      <li id="n-currentevents"><a href="../../../../articles/c/u/r/Peragro_Tempus_Wiki%7ECurrent_events_57bd.html">Current events</a></li>
	     	      <li id="n-help"><a href="../../../../articles/c/o/n/Help%7EContents_22de.html">Help</a></li>
	     	    </ul>
	  </div>
	</div>
		<div class='portlet' id='p-SEARCH'>
	  <h5>SEARCH</h5>
	  <div class='pBody'>
	    <ul>
	    	    </ul>
	  </div>
	</div>
		<div class='portlet' id='p-TOOLBOX'>
	  <h5>TOOLBOX</h5>
	  <div class='pBody'>
	    <ul>
	    	    </ul>
	  </div>
	</div>
		<div class='portlet' id='p-LANGUAGES'>
	  <h5>LANGUAGES</h5>
	  <div class='pBody'>
	    <ul>
	    	    </ul>
	  </div>
	</div>
		<div id="p-search" class="portlet">
	  <h5><label for="searchInput">Search</label></h5>
	  <div id="searchBody" class="pBody">
	    <form action="javascript:goToStatic(3)" id="searchform"><div>
	      <input id="searchInput" name="search" type="text"
	        accesskey="f" value="" />
	      <input type='submit' name="go" class="searchButton" id="searchGoButton"
	        value="Go" />
	    </div></form>
	  </div>
	</div>
	      </div><!-- end of the left (by default at least) column -->
      <div class="visualClear"></div>
      <div id="footer">
    <div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="../../../../skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>		<ul id="f-list">
	  	  	  <li id="f-credits">This page was last modified 17:18, 28 September 2008 by <a href="../../../../articles/c/y/a/User%7ECyaNox_4c16.html" title="User:CyaNox">Mark Sanders</a>. Based on work by Branko Majic.</li>	  	  <li id="f-about"><a href="../../../../articles/a/b/o/Peragro_Tempus_Wiki%7EAbout_5c7d.html" title="Peragro Tempus Wiki:About">About Peragro Tempus Wiki</a></li>	  <li id="f-disclaimer"><a href="../../../../articles/g/e/n/Peragro_Tempus_Wiki%7EGeneral_disclaimer_934d.html" title="Peragro Tempus Wiki:General disclaimer">Disclaimers</a></li>	  	</ul>
      </div>
    </div>
  </body>
</html>
