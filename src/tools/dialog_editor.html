<html>
<head><title>Simple Dialog Editor</title>
<script>
<!--
// If you're wondering why I'm using parseFloat rather than parseInt even though we know it's never gonna be floating-point, it's because of a bug in Firefox that makes parseInt("08" or "09") = 0
var dialogs=new Array();

function note(msg)
{
  document.getElementById("notes").value+=msg+"\n";
}

function Replace(rep,wit,inside)
{
  while(inside.indexOf(rep)>-1)
  {
    inside=inside.replace(rep,wit);
  }
  return inside;
}

function Answer(label, href)
{
  this.label=label;
  this.href=parseFloat(href);
}

function GetId(dialogNode)
{
  return parseFloat(dialogNode.attributes.getNamedItem("id").nodeValue);
}

function GetType(dialogNode)
{
  x = dialogNode.childNodes;

  for (var j=0; j < x.length; j++)
  {
    if (x[j].nodeType != 3)
    {
		if (x[j].nodeName == "function")
		{
		  return "function";
		}
		else if (x[j].nodeName == "text")
		{
		  return "text";
		}
		else if (x[j].nodeName == "teleport")
		{
		  return "teleport";
		}
		else if (x[j].nodeName == "buy")
		{
		  return "buy";
		}
    }

  }

  note("ERROR: Unkown dialog type!");
  return "UNKNOWN";
}

function GetText(dialogNode)
{
  type = GetType(dialogNode);
  typenode = dialogNode.getElementsByTagName(type)[0];

  return typenode.textContent;
}

function Dialog(dialogNode)
{
  this.id = GetId(dialogNode);
  this.dialogtype = GetType(dialogNode);
  this.dialogtext = GetText(dialogNode);
  this.answers = new Array();

  note("Added dialog with type '"+this.dialogtype+"', id: "+this.id+" and text: '"+this.dialogtext+"'");

  // A function dialog can also produce answers. Label those as the function call, e.g. "Answer: (dialog 64)"
  if(this.dialogtype == "function")
  {
    var pos=0;
    while(this.dialogtext.indexOf("(dialog ",pos)>-1)
    {
      pos=this.dialogtext.indexOf("(dialog ",pos);
      var answer=new Answer(this.dialogtext.substring(pos, this.dialogtext.indexOf(")", pos)+1),
                            this.dialogtext.substring(this.dialogtext.indexOf(" ",pos)+1,this.dialogtext.indexOf(")",pos)));
      note("Adding answer \""+answer.label+"\" linking to dialog "+answer.href);
      this.answers.push(answer);
      pos++;
      note("Dialog(dialogNode)");
    }
  }

  answerNodes = dialogNode.getElementsByTagName("answer");
  for (var i=0; i < answerNodes.length; i++)
  {
    href = -1;
	if (answerNodes[i].attributes.getNamedItem("href"))
	{ href = answerNodes[i].attributes.getNamedItem("href").nodeValue; }

    var answer=new Answer(answerNodes[i].textContent, href);
	note("Adding answer \""+answer.label+"\" linking to dialog "+(answer.href>-1?answer.href:"None (ends dialog)"));
    this.answers.push(answer);
  }
}

function drawdialog(id, parents)
{
  if(id==-1)
  {
    return "[End of conversation]";
  }

  if(parents.indexOf("|"+id+"|")>-1)
  {
    return "Linking to message with ID "+id+", [insert select button here]";
  }

  var array_pos = -1;
  for(var i=0; i < dialogs.length; i++)
  {
    if(dialogs[i].id==id)
    {
      array_pos=i;
    }
  }
  note("Found dialog with ID "+id+" at "+array_pos);

  if(array_pos == -1)
  {
    note("Error - answer pointing to nonexistant dialog ID "+id);
    return "<B>Error - answer pointing to nonexistant dialog ID </B>"+id;
  }

  var colspan=dialogs[array_pos].answers.length;if(colspan<1){colspan=1;}
  var color="#FFFFFF";
  if(parents.split("|").length/2 == Math.round(parents.split("|").length/2))
  {
    color="#E0E0E0";
  }

  var dialog="<table border=\"2\" bgcolor=\""+color+"\"><tr><td colspan=\""+colspan+"\"><b>"+dialogs[array_pos].dialogtype+":</b> "+Replace("<","&lt;",Replace(">","&gt;",dialogs[array_pos].dialogtext))+"</td></tr><tr>";
  for(var i=0;i<dialogs[array_pos].answers.length;i++)
  {
    dialog+="<td valign=\"top\"><b><nobr>Answer: "+dialogs[array_pos].answers[i].label+"</nobr></b><br>"+drawdialog(dialogs[array_pos].answers[i].href,parents+id+"|")+"</td>";
  }

  return dialog+"</tr></table>";
}

function render()
{
  note("Found dialogs ");
  document.getElementById("notes").value="";
  dialogs=new Array();
  var code=document.getElementById("dialogcode").value;

  parser=new DOMParser();
  xmlDoc=parser.parseFromString(code,"text/xml");

  dias = xmlDoc.getElementsByTagName("dialog");

  for (var i=0; i < dias.length; i++)
  {
    var dialog = new Dialog(dias[i]);
    dialogs.push(dialog);
  }

  document.getElementById("dialog_tables").innerHTML=drawdialog(0,"|");
}
//-->
</script></head>
<body>
<textarea id="dialogcode" rows="10" cols="70">Paste the content of an NPC's XML here and click "Render"</textarea>
<textarea id="notes" rows="10" cols="70">Message field, this field will be filled with debug messages, rather than those pesky popups</textarea>
<br>
<button onclick="render();">Render</button>
<div id="dialog_tables">

</div>
</body>
</html>
