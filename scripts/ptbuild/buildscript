#!/bin/bash

# PeragroBuilder is copyrighted by Peragro Tempus Team
# PTBuild is released under the General Public license (Please refer to GPL.txt)
# Written By Brant Watson (aka Induane)


# Set some easy initial variables. Defaults should work fine but this way they can be easily changed.
VERSION="0.1"
PASS_TRIES=3
CHECKOUT_TRIES=3
CS_SVN='https://crystal.svn.sourceforge.net/svnroot/crystal/CS/trunk CS_latest'
CEL_SVN='https://cel.svn.sourceforge.net/svnroot/cel/cel/trunk CEL_latest'
CEGUI_DL='http://prdownloads.sourceforge.net/crayzedsgui/CEGUI-0.6.1.tar.gz?download'
CEGUI_FN='CEGUI-0.6.1.tar.gz'
CEGUI_DN='CEGUI-0.6.1'



function INSTALL_DIR_CHOOSE {

	RET=`zenity --list --radiolist --width=480 --height=100 \
		--title "PTBuild version $version" \
		--column="" --column $"Select Your Processor" --column $"Description" \
		TRUE    $"Default Directories"	$"Installs to /opt/peragro_svn" \
	        FALSE   $"Custom Directory"   	$"Choose custom install directory."`		

	if echo "$RET" | grep $"Default"; then

		INSTALL_DIR=/opt
		ptir=$INSTALL_DIR/peragro_svn/peragro
		exit_var=1

	fi
	if echo "$RET" | grep $"Custom"; then

		INSTALL_DIR=$(zenity --file-selection --directory)
		ptdir=$INSTALL_DIR/peragro_svn/peragro
		exit_var=1

	fi

}
function CHOOSE_OPTIMIZATION {
	# Asks user to select their processor
	RET=`zenity --list --radiolist --width=700 --height=285 \
		--title "PTBuild version $version" \
		--column="" --column $"Select Your Processor" --column $"Description" \
		TRUE    $"Generic Build"	$"Compile with no optimizations." \
		FALSE   $"Automatic"		$"Attempt to detect best optimizations."`		


	if echo "$RET" | grep $"Generic"; then
		exit_var=1
		cal3dconfig="./configure --prefix=$CAL3D"
		csconfig="./configure --without-python --without-java --with-libcal3d=$CAL3D"
		celconfig="./configure --without-python"
		begin

	fi

	if echo "$RET" | grep $"Automatic"; then
		exit_var=1
		cal3dconfig="./configure --prefix=$CAL3D"
		csconfig="./configure --without-python --without-java --with-libcal3d=$CAL3D --enable-cpu-specific-optimizations=max"
		celconfig="./configure --without-python"
		begin

	fi
}
function BUILD_ENV {
	sudo mkdir $INSTALL_DIR/peragro_svn
	sudo chmod -R a+rw $INSTALL_DIR
	touch $INSTALL_DIR/peragro_svn/ptbuild.log
	cd $INSTALL_DIR/peragro_svn

}
function GET_CS_SOURCE {
		cd $ptdir
		for (( i=1; i<=$CHECKOUT_TRIES; i++ )); do
			echo "Getting source code for CrystalSpace."
			echo "This will probably take a while so be patient."
			echo t |  svn co $CS_SVN >> log.log 2>&1
			# exit loop if successful
			[ "$?" -eq "0" ] && break
		done
        # "i" greater than $CHECKOUT_TRIES means svn checkout failed
        if [ "$i" -gt "$CHECKOUT_TRIES" ]; then
			echo "Checkout of crystalspace has failed. Please check your net connection or try again later."
			exit 0
		fi 

}
function GET_CEL_SOURCE {
		cd $ptdir
        for (( i=1; i<=$CHECKOUT_TRIES; i++ )); do
			echo "Getting source code for CEL."
			echo "This will probably take a while so be patient."
			echo t | svn co $CEL_SVN >> log.log 2>&1
			# exit loop if successful
			[ "$?" -eq "0" ] && break
        done
        # "i" greater than $CHECKOUT_TRIES means svn checkout failed
        if [ "$i" -gt "$CHECKOUT_TRIES" ]; then
			echo "Checkout of CEL has failed. Please check your net connection or try again later."
			exit 0
		fi 

}
function GET_CEGUI_SOURCE {
		cd $ptdir
        for (( i=1; i<=$CHECKOUT_TRIES; i++ )); do
			echo "Getting source code for CEGUI."
			echo "This will probably go quickly."
			wget -c $CEGUI_DL>> log.log 2>&1
			# exit loop if successful
			[ "$?" -eq "0" ] && break
        done
        # "i" greater than $CHECKOUT_TRIES means svn checkout failed
        if [ "$i" -gt "$CHECKOUT_TRIES" ]; then
			echo "Download of CEGUI has failed. Please check your net connection or try again later."
			exit 0
		fi 
		tar -xf $CEGUI_FN
		rm $CEGUI_FN

}
function COMPILE_CEL {
	echo "Compiling CEL"
	cd $INSTALL_DIR/CEL_latest
	./autogen.sh
	./configure
	jam -aq libs plugins cel-config
}
function COMPILE_CS {
	cd $INSTALL_DIR/CS_latest
	echo "Compiling CrystalSpace"
	./configure --without-java --without-lib3ds --without-libaws --with-CEGUI=$CEGUI
	jam -aq libs plugins cs-config walktest basemapgen lighter2
}
function COMPILE_CEGUI {
	cd $INSTALL_DIR
	tar -xf $CEGUI_FN
	cd $INSTALL_DIR/$CEGUI_DN
	echo "Compiling CEGUI"
	./configure --prefix=$CEGUI --disable-xerces-c
	make
	make install
}
function RESOLVE_KARMIC {

	# attempt to resolve dependencies
	(
        echo "10" ; sleep 3 && DPKG_CHECK
        echo "# Updating Sources Cache"
        echo "35" ; sudo apt-get update
        echo "# Installing Software"
        echo "50" ; sudo apt-get --assume-yes install libjpeg62-dev x11proto-gl-dev autoconf jam bison flex-old automake1.9 libcurl4-openssl-dev libmng-dev libmikmod2-dev libogg-dev libvorbis-dev zlib1g-dev libpng12-dev build-essential libtool libglu1-mesa-dev libglu1-xorg-dev xserver-xorg-dev libxt-dev libopenal1 libopenal-dev subversion zlibc libfreetype6-dev libfreetype6 libasound2-dev alsa-oss libxxf86vm-dev libxext-dev x11proto-xext-dev libboost1.40-dev libxerces-c2-dev libode0-dev swig libpcre3-dev
        echo "# Finishing Up..."
        echo "100"
        ) |
        zenity --progress \
          --title="Dependency Resolution" \
          --text="Checking if any package managers are running" \
          --percentage=0
}
function DPKG_CHECK {

	# Makes sure package manager isn't running.
	if ps -U root -u root u | grep "synaptic" | grep -v grep;
		then zenity --info --title "PTBuild" --text $"PTBuild WILL NOT run while Synaptic is running. Please close Synaptic";
	exit 1;
	elif ps -U root -u root u | grep "update-manager" | grep -v grep;
		then zenity --info --title "PTBuild" --text $"PTBuild WILL NOT while update-manager is running. Please close update-manager";
	exit 1;
	elif ps -U root -u root u | grep "apt-get" | grep -v grep;
		then zenity --info --title "PTBuild" --text $"PTBuild WILL NOT run while you are also running apt-get. Please finish what you were doing with apt and restart this script.";
	exit 1;
	elif ps -U root -u root u | grep "dpkg" | grep -v grep;
		then zenity --info --title "PTBuild" --text $"PTBuild WILL NOT run while you are installing packages with dpkg. Please finish installing your package and rerun PTBuild";
	exit 0;
	kill -9 $ZENITY_PID

fi



}
function ASK {

	# Asks user if they want to attempt to resolve dependancies.
	zenity --question --text $"Would you like to attempt to get all software needed to compile Peragro? (Only necessary if this is the first time you have run this script.) "
	if [ $? -eq 0 ] ; then
		RESOLVE_KARMIC
	fi


}
function BUILD_SOURCES {
		
		# Runs functions that build source code.
		buildcal3d
		killall zenity
		buildcs
		killall zenity
		buildcel
		killall zenity
		psbuild
		killall zenity
		update
		killall zenity

}
function PASSWORD {
sudo -k
	for (( i=1; i<=$PASS_TRIES; i++ )); do
		zenity --entry --title "Password Prompt" --hide-text --text $"Enter your password (try #$i of $PASS_TRIES)." | 		sudo -S -v

# exit loop if password was correct
	[ "$?" -eq "0" ] && break
	done
	# "i" greater than $PASS_TRIES means $PASS_TRIES failed tries
	[ "$i" -gt "$PASS_TRIES" ] && { zenity --error --text "Failed to enter correct password, exiting..."; exit 1; }
}



INSTALL_DIR_CHOOSE
# setup_profile
BUILD_ENV
ASK
CHOOSE_OPTIMIZATION

exit 0
